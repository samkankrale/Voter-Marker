<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Booth-wise Voter Lists - VoterMarker</title>

<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: "Segoe UI", system-ui, sans-serif;
    background: #bebebe;
    color: #333;
}

.container {
    max-width: 1400px;
    margin: auto;
    padding: 20px;
}

/* ================= HEADER ================= */
.header {
    background: white;
    border-radius: 12px;
    padding: 20px 25px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 6px 14px rgba(0,0,0,0.08);
    margin-bottom: 20px;
}

.header h2 {
    font-size: 22px;
    color: #2E7D32;
}

.header-right {
    display: flex;
    gap: 10px;
    align-items: center;
}

.btn-back {
    background: #1976D2;
    color: white;
    border: none;
    padding: 10px 18px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
}

.btn-back:hover {
    background: #1565C0;
}

.btn-logout {
    background: #e53935;
    color: white;
    border: none;
    padding: 10px 18px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
}

.btn-logout:hover {
    background: #c62828;
}

/* ================= BOOTH SELECTOR ================= */
.booth-selector {
    background: white;
    border-radius: 12px;
    padding: 25px;
    box-shadow: 0 6px 14px rgba(0,0,0,0.08);
    margin-bottom: 20px;
}

.booth-selector h3 {
    margin-bottom: 20px;
    color: #1976D2;
    font-size: 18px;
}

.selector-wrapper {
    display: flex;
    gap: 15px;
    align-items: flex-end;
    flex-wrap: wrap;
}

.form-group {
    flex: 1;
    min-width: 250px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #424242;
    font-size: 14px;
}

.form-group select {
    width: 100%;
    padding: 12px;
    border: 2px solid #ddd;
    border-radius: 6px;
    font-size: 14px;
    background: white;
    cursor: pointer;
}

.form-group select:focus {
    outline: none;
    border-color: #4CAF50;
}

.btn-load {
    padding: 12px 30px;
    background: #4CAF50;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 15px;
    font-weight: 600;
}

.btn-load:hover {
    background: #43a047;
}

.btn-load:disabled {
    background: #ccc;
    cursor: not-allowed;
}

/* ================= STATS CARDS ================= */
.stats-container {
    display: none;
    margin-bottom: 20px;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
}

.stat-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    text-align: center;
    box-shadow: 0 6px 14px rgba(0,0,0,0.08);
    border-left: 4px solid #4CAF50;
}

.stat-card.visited {
    border-left-color: #4CAF50;
}

.stat-card.unvisited {
    border-left-color: #FF9800;
}

.stat-card.percentage {
    border-left-color: #1976D2;
}

.stat-card h4 {
    font-size: 13px;
    color: #666;
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.stat-card .value {
    font-size: 32px;
    font-weight: bold;
    color: #2E7D32;
}

.stat-card.unvisited .value {
    color: #F57C00;
}

.stat-card.percentage .value {
    color: #1976D2;
}

/* ================= LOADING ================= */
.loading {
    display: none;
    text-align: center;
    padding: 40px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 6px 14px rgba(0,0,0,0.08);
}

.spinner {
    width: 50px;
    height: 50px;
    border: 4px solid #eee;
    border-top: 4px solid #4CAF50;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: auto;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.loading p {
    margin-top: 15px;
    color: #666;
    font-size: 14px;
}

/* ================= TABLE CONTAINER ================= */
.table-container {
    display: none;
    background: white;
    border-radius: 12px;
    box-shadow: 0 6px 14px rgba(0,0,0,0.08);
    overflow: hidden;
}

.table-header {
    padding: 20px 25px;
    background: #f5f5f5;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 2px solid #e0e0e0;
}

.table-header h3 {
    font-size: 18px;
    color: #2E7D32;
}

.btn-download {
    background: #1976D2;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 600;
}

.btn-download:hover {
    background: #1565C0;
}

.table-wrapper {
    overflow-x: auto;
    max-height: 600px;
    overflow-y: auto;
}

table {
    width: 100%;
    border-collapse: collapse;
}

thead {
    position: sticky;
    top: 0;
    z-index: 10;
}

th {
    background: #4CAF50;
    color: white;
    padding: 14px 10px;
    font-size: 13px;
    white-space: nowrap;
    text-align: center;
    font-weight: 600;
}

td {
    padding: 12px 10px;
    border-bottom: 1px solid #eee;
    font-size: 13px;
    text-align: center;
}

tr.visited {
    background: #E8F5E9;
}

tr.not-visited {
    background: #FFF3E0;
}

tr:hover {
    background: #f0f0f0;
}

tr.visited:hover {
    background: #C8E6C9;
}

tr.not-visited:hover {
    background: #FFE0B2;
}

.status-badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
}

.status-badge.visited {
    background: #C8E6C9;
    color: #2E7D32;
}

.status-badge.not-visited {
    background: #FFCCBC;
    color: #D84315;
}

.no-data {
    padding: 60px 20px;
    text-align: center;
    background: white;
    border-radius: 12px;
    box-shadow: 0 6px 14px rgba(0,0,0,0.08);
}

.no-data-icon {
    font-size: 64px;
    margin-bottom: 20px;
}

.no-data h3 {
    color: #666;
    margin-bottom: 10px;
    font-size: 20px;
}

.no-data p {
    color: #999;
    font-size: 14px;
}

/* ================= RESPONSIVE ================= */
@media (max-width: 768px) {
    .header {
        flex-direction: column;
        gap: 15px;
    }

    .header-right {
        width: 100%;
        justify-content: center;
    }

    .selector-wrapper {
        flex-direction: column;
    }

    .form-group {
        width: 100%;
    }

    .btn-load {
        width: 100%;
    }

    .stats-grid {
        grid-template-columns: 1fr;
    }

    .table-header {
        flex-direction: column;
        gap: 15px;
        align-items: flex-start;
    }

    .btn-download {
        width: 100%;
        justify-content: center;
    }

    th, td {
        font-size: 11px;
        padding: 8px 5px;
    }
}
</style>
</head>

<body>
<div class="container">
    <!-- Header -->
    <div class="header">
        <h2>üìä Booth-wise Voter Lists</h2>
        <div class="header-right">
            <button class="btn-back" onclick="goBack()">‚Üê Back to Dashboard</button>
            <button class="btn-logout" onclick="logout()">Logout</button>
        </div>
    </div>

    <!-- Booth Selector -->
    <div class="booth-selector">
        <h3>üó≥Ô∏è Select Booth</h3>
        <div class="selector-wrapper">
            <div class="form-group">
                <label for="boothSelect">Choose a booth:</label>
                <select id="boothSelect">
                    <option value="">-- Select Booth --</option>
                </select>
            </div>
            <button class="btn-load" id="loadBtn" onclick="loadBoothVoters()" disabled>
                Load Voters
            </button>
        </div>
    </div>

    <!-- Statistics -->
    <div class="stats-container" id="statsContainer">
        <div class="stats-grid">
            <div class="stat-card">
                <h4>Total Voters</h4>
                <div class="value" id="totalVoters">0</div>
            </div>
            <div class="stat-card visited">
                <h4>‚úì Visited</h4>
                <div class="value" id="visitedCount">0</div>
            </div>
            <div class="stat-card unvisited">
                <h4>‚úó Not Visited</h4>
                <div class="value" id="unvisitedCount">0</div>
            </div>
            <div class="stat-card percentage">
                <h4>Visit Rate</h4>
                <div class="value" id="visitPercentage">0%</div>
            </div>
        </div>
    </div>

    <!-- Loading -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>Loading booth data...</p>
    </div>

    <!-- Table -->
    <div class="table-container" id="tableContainer">
        <div class="table-header">
            <h3 id="tableTitle">Voter List</h3>
            <button class="btn-download" onclick="downloadBoothPDF()">
                <span>üìÑ</span>
                <span>Download PDF</span>
            </button>
        </div>
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>Sr No</th>
                        <th>Voter ID</th>
                        <th>Name (English)</th>
                        <th>Name (Marathi)</th>
                        <th>Relative Name</th>
                        <th>Age</th>
                        <th>Gender</th>
                        <th>Status</th>
                        <th>Visited By</th>
                        <th>Visit Date</th>
                    </tr>
                </thead>
                <tbody id="votersTable">
                </tbody>
            </table>
        </div>
    </div>

    <!-- No Data Message -->
    <div class="no-data" id="noData" style="display:none;">
        <div class="no-data-icon">üì≠</div>
        <h3>No Data Available</h3>
        <p>Please select a booth to view voter information</p>
    </div>
</div>

<script>
    const API = "";
    let selectedBooth = null;
    let currentBoothData = null;

    // Check authentication and admin status
    if (!localStorage.getItem("token")) {
        window.location.href = "/";
    }

    if (localStorage.getItem("isAdmin") !== "true") {
        alert("Access denied. This page is only for administrators.");
        window.location.href = "/";
    }

    // Load booths on page load
    loadBooths();

    function loadBooths() {
        fetch(API + "/admin/booths", {
            headers: {
                "Authorization": "Bearer " + localStorage.getItem("token")
            }
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === "Success") {
                const select = document.getElementById("boothSelect");
                select.innerHTML = '<option value="">-- Select Booth --</option>';
                
                data.data.forEach(booth => {
                    const option = document.createElement("option");
                    option.value = booth.Booths;
                    option.textContent = booth.Booths;
                    select.appendChild(option);
                });

                // Enable load button when booth is selected
                select.addEventListener('change', function() {
                    const loadBtn = document.getElementById("loadBtn");
                    loadBtn.disabled = !this.value;
                    selectedBooth = this.value;
                });
            } else {
                alert("Error loading booths: " + data.message);
            }
        })
        .catch(error => {
            console.error("Error:", error);
            alert("Error loading booths. Please try again.");
        });
    }

    function loadBoothVoters() {
        if (!selectedBooth) {
            alert("Please select a booth first");
            return;
        }

        // Hide previous data
        document.getElementById("statsContainer").style.display = "none";
        document.getElementById("tableContainer").style.display = "none";
        document.getElementById("noData").style.display = "none";
        
        // Show loading
        document.getElementById("loading").style.display = "block";

        fetch(API + `/admin/booth-voters/${encodeURIComponent(selectedBooth)}`, {
            headers: {
                "Authorization": "Bearer " + localStorage.getItem("token")
            }
        })
        .then(res => res.json())
        .then(data => {
            document.getElementById("loading").style.display = "none";

            if (data.status === "Success") {
                currentBoothData = data.data;
                displayBoothData(data.data);
            } else {
                alert("Error loading booth data: " + data.message);
                document.getElementById("noData").style.display = "block";
            }
        })
        .catch(error => {
            console.error("Error:", error);
            document.getElementById("loading").style.display = "none";
            alert("Error loading booth data. Please try again.");
            document.getElementById("noData").style.display = "block";
        });
    }

    function displayBoothData(data) {
        const { booth_name, voters, stats } = data;

        // Update statistics
        document.getElementById("totalVoters").textContent = stats.total_voters;
        document.getElementById("visitedCount").textContent = stats.visited;
        document.getElementById("unvisitedCount").textContent = stats.unvisited;
        document.getElementById("visitPercentage").textContent = stats.visit_percentage + "%";
        document.getElementById("statsContainer").style.display = "block";

        // Update table title
        document.getElementById("tableTitle").textContent = `Voter List - ${booth_name}`;

        // Populate table
        const tbody = document.getElementById("votersTable");
        tbody.innerHTML = "";

        if (voters.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="10" style="padding: 40px; text-align: center; color: #999;">
                        No voters found for this booth
                    </td>
                </tr>
            `;
        } else {
            voters.forEach(voter => {
                const isVisited = !!voter.visited_by_name;
                const gender = voter.gender === '‡§™‡•Å' || voter.gender === 'M' || voter.gender === 'Male' ? 'Male' : 
                              voter.gender === '‡§∏‡•ç‡§§‡•ç‡§∞‡•Ä' || voter.gender === 'F' || voter.gender === 'Female' ? 'Female' : 
                              voter.gender;
                
                const visitDate = voter.visited_at 
                    ? new Date(voter.visited_at).toLocaleDateString('en-GB')
                    : '-';

                const row = `
                    <tr class="${isVisited ? 'visited' : 'not-visited'}">
                        <td>${voter.serial_no}</td>
                        <td>${voter.voter_id}</td>
                        <td>${voter.voter_name_en || '-'}</td>
                        <td>${voter.voter_name || voter.voter_name_en || '-'}</td>
                        <td>${voter.relative_name || '-'}</td>
                        <td>${voter.age}</td>
                        <td>${gender}</td>
                        <td>
                            <span class="status-badge ${isVisited ? 'visited' : 'not-visited'}">
                                ${isVisited ? '‚úì Visited' : '‚úó Not Visited'}
                            </span>
                        </td>
                        <td>${voter.visited_by_name || '-'}</td>
                        <td>${visitDate}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        document.getElementById("tableContainer").style.display = "block";
    }

    function downloadBoothPDF() {
        if (!selectedBooth) {
            alert("Please select a booth first");
            return;
        }

        const btn = event.target.closest('button');
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span>‚è≥</span><span>Generating PDF...</span>';

        fetch(API + `/admin/download-booth-pdf/${encodeURIComponent(selectedBooth)}`, {
            method: "GET",
            headers: {
                "Authorization": "Bearer " + localStorage.getItem("token")
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error("Failed to generate PDF");
            }
            return response.blob();
        })
        .then(blob => {
            // Create download link
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `booth_${selectedBooth.replace(/ /g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
            document.body.appendChild(a);
            a.click();
            
            // Cleanup
            setTimeout(() => {
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            }, 100);
            
            btn.disabled = false;
            btn.innerHTML = originalText;
            alert("‚úÖ PDF downloaded successfully!");
        })
        .catch(error => {
            console.error("Error:", error);
            btn.disabled = false;
            btn.innerHTML = originalText;
            alert("Error downloading PDF. Please try again.");
        });
    }

    function goBack() {
        window.location.href = "/";
    }

    function logout() {
        localStorage.removeItem("token");
        localStorage.removeItem("isAdmin");
        localStorage.removeItem("userName");
        window.location.href = "/";
    }
</script>

</body>
</html>