<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VoterMarker - A Voter Visit System</title>

<style>
/* ================= RESET ================= */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: "Segoe UI", system-ui, sans-serif;
    background: #bebebe;
    color: #333;
}

/* ================= LOGIN PAGE ================= */
#loginBox {
    min-height: 100vh;
    background: url("/static/login-bg.png") center / cover no-repeat;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 20px;
}

.loginwrapper {
    width: 100%;
    max-width: 450px;
}

#title {
    text-align: center;
    margin-bottom: 35px;
    font-size: 40px;
    color: white;
    font-weight: bold;
}

.login-card {
    width: 100%;
    background: rgba(255,255,255,0.15);
    backdrop-filter: blur(14px);
    border-radius: 16px;
    padding: 40px;
    box-shadow: 0 25px 45px rgba(0,0,0,0.35);
    border: 1px solid rgba(255,255,255,0.25);
}

.login-card h2 {
    text-align: center;
    color: #fff;
    margin-bottom: 25px;
    font-size: 26px;
}

.labels {
    color: white;
    font-size: 16px;
    font-weight: bold;
}

.login-card input {
    width: 100%;
    padding: 14px;
    margin-bottom: 18px;
    border-radius: 6px;
    border: none;
    font-size: 14px;
}

.login-card input:focus {
    outline: none;
}

.btn-login {
    width: 100%;
    padding: 14px;
    background: #4CAF50;
    border: none;
    color: white;
    font-size: 15px;
    border-radius: 6px;
    cursor: pointer;
}

.btn-login:hover {
    background: #43a047;
}

#loginMsg {
    margin-top: 15px;
    text-align: center;
    color: #ffebee;
    font-size: 14px;
}

/* ================= DASHBOARD ================= */
.container {
    max-width: 1200px;
    margin: auto;
    padding: 20px;
    background-color: lightgrey;
}

/* ================= HEADER ================= */
.header {
    background: white;
    border-radius: 12px;
    padding: 20px 25px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 6px 14px rgba(0,0,0,0.08);
}

.header h2 {
    font-size: 22px;
}

.header-right {
    display: flex;
    gap: 10px;
    align-items: center;
}

.btn-logout {
    background: #e53935;
    color: white;
    border: none;
    padding: 10px 18px;
    border-radius: 6px;
    cursor: pointer;
}

.btn-download-pdf {
    background: #1976D2;
    color: white;
    border: none;
    padding: 10px 18px;
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 5px;
}

/* ================= ADMIN STATS ================= */
.admin-stats {
    margin-top: 20px;
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 6px 14px rgba(0,0,0,0.08);
}

.admin-stats h3 {
    margin-bottom: 15px;
    color: #2E7D32;
}

.user-stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 15px;
}

.user-stat-card {
    background: #f5f5f5;
    padding: 15px;
    border-radius: 8px;
    border-left: 4px solid #4CAF50;
}

.user-stat-card h4 {
    font-size: 16px;
    margin-bottom: 8px;
}

.user-stat-card .stat-value {
    font-size: 24px;
    font-weight: bold;
    color: #4CAF50;
}

.user-stat-card .stat-label {
    font-size: 12px;
    color: #666;
}

/* ================= SEARCH ================= */
.search-container {
    margin-top: 20px;
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 6px 14px rgba(0,0,0,0.08);
}

.search-wrapper {
    display: flex;
    gap: 10px;
}

#searchInput {
    flex: 1;
    padding: 14px;
    border-radius: 6px;
    border: 1px solid #ddd;
}

.clear-search {
    background: none;
    border: none;
    font-size: 20px;
    cursor: pointer;
    display: none;
}

.btn-search {
    padding: 14px 24px;
    border-radius: 6px;
    background: #4CAF50;
    color: white;
    border: none;
    cursor: pointer;
}

.search-info {
    margin-top: 10px;
    font-size: 13px;
    color: #666;
}

.search-results-info {
    margin-top: 10px;
    padding: 10px;
    background: #e8f5e9;
    border-radius: 6px;
    font-size: 14px;
}

/* ================= LOADING ================= */
.loading {
    display: none;
    text-align: center;
    padding: 20px;
}

.spinner {
    width: 40px;
    height: 40px;
    border: 4px solid #eee;
    border-top: 4px solid #4CAF50;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: auto;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* ================= STATS ================= */
#statsBox {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
    margin: 20px 0;
}

.stat {
    background: white;
    border-radius: 12px;
    padding: 25px;
    text-align: center;
    box-shadow: 0 6px 14px rgba(0,0,0,0.08);
}

.stat h3 {
    font-size: 14px;
    color: #666;
}

.stat span {
    font-size: 34px;
    font-weight: bold;
    color: #4CAF50;
}

/* ================= TABLE ================= */
.table-container {
    background: white;
    border-radius: 12px;
    box-shadow: 0 6px 14px rgba(0,0,0,0.08);
    overflow: hidden;
}

.table-wrapper {
    overflow-x: auto;
}

table {
    width: 100%;
    border-collapse: collapse;
}

th {
    background: #4CAF50;
    color: white;
    padding: 14px;
    font-size: 14px;
    white-space: nowrap;
}

td {
    padding: 12px;
    border-bottom: 1px solid #eee;
    white-space: nowrap;
}

tr.visited {
    background: #e8f5e9;
}

.btn-mark {
    background: #4CAF50;
    border: none;
    color: white;
    padding: 6px 14px;
    border-radius: 4px;
    cursor: pointer;
}

/* ================= PAGINATION ================= */
.pagination {
    padding: 15px;
    text-align: center;
}

.pagination button {
    padding: 8px 18px;
    border-radius: 6px;
    background: #4CAF50;
    border: none;
    color: white;
}

/* ================= POPUP ================= */
.popup-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
}

.popup-box {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    border-radius: 12px;
    padding: 25px;
    width: 90%;
    max-width: 400px;
}

.popup-buttons {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
}

.btn-cancel {
    background: #9e9e9e;
    border: none;
    padding: 10px 16px;
    border-radius: 6px;
    color: white;
}

.btn-yes {
    background: #4CAF50;
    border: none;
    padding: 10px 16px;
    border-radius: 6px;
    color: white;
}

/* ================= RESPONSIVE ================= */
/* ================= RESPONSIVE ================= */
@media (max-width: 767px) {
    /* Enable flexbox on container for mobile reordering */
    #voterBox {
        display: flex !important;
        flex-direction: column !important;
    }
    
    /* Set order for mobile layout */
    .header {
        order: 1 !important;
    }
    
    .admin-stats {
        order: 2 !important;
    }
    
    .search-container {
        order: 3 !important;
    }
    
    .loading {
        order: 4 !important;
        margin: 0 !important;
    }
    
    .table-container {
        order: 4 !important;
    }
    
    #statsBox {
        order: 10 !important;
        grid-template-columns: 1fr;
    }

    .search-wrapper {
        flex-direction: column;
    }

    .user-stats-grid {
        grid-template-columns: 1fr;
    }

    .header-right {
        flex-direction: column;
    }
}

@media (max-width: 375px) {
    #title {
        font-size: 26px;
    }

    .login-card {
        padding: 25px;
    }

    .stat span {
        font-size: 28px;
    }

    table th,
    table td {
        font-size: 12px;
        padding: 8px;
    }

    .btn-mark {
        font-size: 12px;
        padding: 4px 10px;
    }
}

</style>
</head>

<body>
<!-- LOGIN -->
<div id="loginBox">
    <div class="loginwrapper">
        <h2 id="title">VoterMarker</h2>
        <div class="login-card">
            <h2>LogIn</h2>
            <label class="labels">Username:</label>
            <input type="text" id="username" placeholder="Username">
            <label class="labels">Password:</label>
            <input type="password" id="password" placeholder="Password">
            <button class="btn-login" onclick="login()">Login</button>
            <p id="loginMsg"></p>
        </div>
    </div>
</div>

<!-- VOTERS PAGE -->
<div class="container" id="voterBox" style="display:none;">
    <div class="header">
        <h2 id="headerTitle">Voter List</h2>
        <div class="header-right">
            <button class="btn-download-pdf" id="downloadPdfBtn" style="display:none;" onclick="downloadPDF()">
                üìÑ Download PDF
            </button>
            <button class="btn-logout" onclick="logout()">Logout</button>
        </div>
    </div>

    <!-- Admin User Stats -->
    <div class="admin-stats" id="adminStats" style="display:none;">
        <h3>üìä User-wise Marking Statistics</h3>
        <div class="user-stats-grid" id="userStatsGrid"></div>
    </div>

    <div class="search-container">
        <div class="search-wrapper">
            <input type="text" id="searchInput" placeholder="Search by Voter ID or Name" oninput="handleSearch()">
            <button class="clear-search" onclick="clearSearch()">‚úï</button>
            <button class="btn-search" onclick="performSearch()">Search</button>
        </div>
        <div class="search-info" id="searchInfo">üí° Type at least 3 characters</div>
        <div class="search-results-info" id="searchResults" style="display:none;"></div>
    </div>

    <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>Loading...</p>
    </div>

    <div id="statsBox">
        <div class="stat"><h3>Total Voters</h3><span id="totalVoters">0</span></div>
        <div class="stat"><h3>Total Marked</h3><span id="totalMarked">0</span></div>
        <div class="stat"><h3>Marked By Me</h3><span id="markedByMe">0</span></div>
    </div>

    <div class="table-container">
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>Sr No</th>
                        <th>Voter ID</th>
                        <th>Name</th>
                        <th>Middle Name</th>
                        <th>Age</th>
                        <th>Gender</th>
                        <th>Status</th>
                        <th id="actionHeader">Action</th>
                    </tr>
                </thead>
                <tbody id="voterTable"></tbody>
            </table>
        </div>

        <div class="pagination">
            <button onclick="prevPage()" id="prevBtn">Prev</button>
            <span id="pageNo">1</span>
            <button onclick="nextPage()" id="nextBtn">Next</button>
        </div>
    </div>
</div>

<!-- CONFIRM POPUP -->
<div class="popup-overlay" id="popupOverlay">
    <div class="popup-box">
        <h3>Confirm</h3>
        <p>Mark <strong id="voterName"></strong> as visited?</p>
        <div class="popup-buttons">
            <button class="btn-cancel" onclick="closePopup()">Cancel</button>
            <button class="btn-yes" onclick="confirmMark()">Yes</button>
        </div>
    </div>
</div>


<script>
    const API = "";
    let page = 1;
    let selectedVoterId = null;
    let searchQuery = "";
    let searchTimeout = null;
    let isAdmin = false;

    // AUTO LOGIN CHECK
    if (localStorage.getItem("token")) {
        showVoters();
    }

    function login() {
        fetch(API + "/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                username: document.getElementById("username").value,
                password: document.getElementById("password").value
            })
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === "Success") {
                localStorage.setItem("token", data.data.token);
                localStorage.setItem("isAdmin", data.data.is_admin);
                localStorage.setItem("userName", data.data.user);
                showVoters();
            } else {
                document.getElementById("loginMsg").innerText = data.Message;
            }
        });
    }

    function showVoters() {
        document.getElementById("loginBox").style.display = "none";
        document.getElementById("voterBox").style.display = "block";
        
        isAdmin = localStorage.getItem("isAdmin") === "true";
        
        if (isAdmin) {
            // Admin view
            document.getElementById("headerTitle").innerText = "Voter List (Admin View)";
            document.getElementById("downloadPdfBtn").style.display = "flex";
            document.getElementById("adminStats").style.display = "block";
            document.getElementById("actionHeader").style.display = "none";
            loadUserStats();
        }
        
        loadStats();
        loadVoters();
    }

    function loadUserStats() {
        fetch(API + "/admin/user-wise-stats", {
            headers: {
                "Authorization": "Bearer " + localStorage.getItem("token")
            }
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === "Success") {
                const grid = document.getElementById("userStatsGrid");
                let html = "";
                
                data.data.forEach(user => {
                    html += `
                        <div class="user-stat-card">
                            <h4>${user.name}</h4>
                            <div class="stat-value">${user.total_marked}</div>
                            <div class="stat-label">voters marked</div>
                            ${user.last_visit ? `<div class="stat-label" style="margin-top: 5px;">Last: ${new Date(user.last_visit).toLocaleDateString()}</div>` : ''}
                        </div>
                    `;
                });
                
                grid.innerHTML = html;
            }
        });
    }

    // Global variable to track download
let currentDownloadController = null;
let downloadProgressInterval = null;

// Check for pending download on page load
window.addEventListener('DOMContentLoaded', function() {
    checkPendingDownload();
});

function checkPendingDownload() {
    const pendingDownload = localStorage.getItem('pendingPdfDownload');
    if (pendingDownload) {
        const downloadData = JSON.parse(pendingDownload);
        const timeElapsed = Date.now() - downloadData.startTime;
        
        // If less than 10 minutes old, offer to resume
        if (timeElapsed < 600000) {
            if (confirm('You have a pending PDF download.\n\nWould you like to resume it?')) {
                resumeDownload(downloadData);
            } else {
                localStorage.removeItem('pendingPdfDownload');
            }
        } else {
            // Too old, remove it
            localStorage.removeItem('pendingPdfDownload');
        }
    }
}

function resumeDownload(downloadData) {
    // Calculate how much time has passed
    const timeElapsed = Date.now() - downloadData.startTime;
    const estimatedTotal = 240000; // 4 minutes in ms
    const startProgress = Math.min((timeElapsed / estimatedTotal) * 100, 95);
    
    // Start the download again with resumed progress
    startPdfDownload(startProgress, downloadData.startTime);
}

function downloadPDF() {
    if (currentDownloadController) {
        alert('A download is already in progress. Please wait or cancel it first.');
        return;
    }
    
    if (!confirm('‚ö†Ô∏è This will generate a large PDF with all voter data.\n\nThis may take 3-5 minutes.\n\nYou can cancel anytime or refresh the page - the download will resume.\n\nClick OK to continue.')) {
        return;
    }
    
    // Save download state
    const downloadData = {
        startTime: Date.now(),
        status: 'downloading'
    };
    localStorage.setItem('pendingPdfDownload', JSON.stringify(downloadData));
    
    startPdfDownload(0, downloadData.startTime);
}

function startPdfDownload(startProgress = 0, startTime = Date.now()) {
    // Create AbortController for cancellation
    currentDownloadController = new AbortController();
    
    // Show custom progress UI
    showDownloadProgress(startProgress, startTime);
    
    const token = localStorage.getItem("token");
    
    fetch(API + "/admin/download-pdf", {
        method: "GET",
        headers: {
            "Authorization": "Bearer " + token
        },
        signal: currentDownloadController.signal
    })
    .then(response => {
        if (!response.ok) {
            return response.text().then(text => {
                try {
                    const json = JSON.parse(text);
                    throw new Error(json.detail || json.message || text);
                } catch (e) {
                    throw new Error(`Server error (${response.status})`);
                }
            });
        }
        return response.blob();
    })
    .then(blob => {
        if (!blob || blob.size === 0) {
            throw new Error("Received empty PDF file");
        }
        
        // Success! Clean up
        clearDownloadProgress();
        localStorage.removeItem('pendingPdfDownload');
        
        // Download the file
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `voters_list_${new Date().toISOString().split('T')[0]}.pdf`;
        document.body.appendChild(a);
        a.click();
        
        setTimeout(() => {
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }, 100);
        
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        alert(`‚úÖ PDF downloaded successfully!\n\nTotal time: ${elapsed} seconds`);
    })
    .catch(error => {
        clearDownloadProgress();
        
        if (error.name === 'AbortError') {
            alert('Download cancelled by user.');
            localStorage.removeItem('pendingPdfDownload');
        } else {
            console.error("Download error:", error);
            alert("Error downloading PDF: " + (error.message || "Unknown error"));
            localStorage.removeItem('pendingPdfDownload');
        }
    });
}

function showDownloadProgress(startProgress, startTime) {
    // Hide main content, show progress overlay
    const overlay = document.createElement('div');
    overlay.id = 'downloadProgressOverlay';
    overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    `;
    
    overlay.innerHTML = `
        <div style="background: white; border-radius: 16px; padding: 40px; max-width: 500px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
            <h2 style="margin: 0 0 20px 0; color: #2E7D32; text-align: center;">
                üìÑ Generating PDF
            </h2>
            
            <div style="margin: 30px 0;">
                <div style="background: #e0e0e0; height: 30px; border-radius: 15px; overflow: hidden; position: relative;">
                    <div id="progressBar" style="background: linear-gradient(90deg, #4CAF50, #81C784); height: 100%; width: ${startProgress}%; transition: width 0.5s ease; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 14px;">
                        <span id="progressText">${Math.round(startProgress)}%</span>
                    </div>
                </div>
            </div>
            
            <div style="text-align: center; margin: 20px 0; color: #666;">
                <p style="margin: 5px 0; font-size: 14px;">‚è±Ô∏è Elapsed: <strong id="elapsedTime">0s</strong></p>
                <p style="margin: 5px 0; font-size: 14px;">‚è≥ Estimated remaining: <strong id="remainingTime">~4min</strong></p>
                <p style="margin: 15px 0 5px 0; font-size: 12px; color: #999;">
                    You can refresh the page - the download will resume automatically
                </p>
            </div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button onclick="cancelDownload()" style="background: #e53935; color: white; border: none; padding: 12px 30px; border-radius: 6px; cursor: pointer; font-size: 15px; font-weight: bold;">
                    ‚úï Cancel Download
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(overlay);
    
    // Animate progress bar (simulated)
    let currentProgress = startProgress;
    const estimatedTotal = 240000; // 4 minutes
    const updateInterval = 500; // Update every 500ms
    
    downloadProgressInterval = setInterval(() => {
        const elapsed = Date.now() - startTime;
        const estimatedProgress = (elapsed / estimatedTotal) * 100;
        
        // Slowly approach estimated progress (never reach 100% until actually done)
        currentProgress = Math.min(currentProgress + 0.5, Math.min(estimatedProgress, 95));
        
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const elapsedTime = document.getElementById('elapsedTime');
        const remainingTime = document.getElementById('remainingTime');
        
        if (progressBar && progressText) {
            progressBar.style.width = currentProgress + '%';
            progressText.textContent = Math.round(currentProgress) + '%';
        }
        
        if (elapsedTime) {
            const seconds = Math.floor(elapsed / 1000);
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            elapsedTime.textContent = minutes > 0 ? `${minutes}m ${secs}s` : `${seconds}s`;
        }
        
        if (remainingTime) {
            const remaining = Math.max(0, estimatedTotal - elapsed);
            const remMinutes = Math.ceil(remaining / 60000);
            remainingTime.textContent = remMinutes > 0 ? `~${remMinutes}min` : 'Almost done...';
        }
    }, updateInterval);
}

function clearDownloadProgress() {
    if (downloadProgressInterval) {
        clearInterval(downloadProgressInterval);
        downloadProgressInterval = null;
    }
    
    const overlay = document.getElementById('downloadProgressOverlay');
    if (overlay) {
        // Animate to 100% before removing
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        if (progressBar && progressText) {
            progressBar.style.width = '100%';
            progressText.textContent = '100%';
        }
        
        setTimeout(() => {
            overlay.remove();
        }, 500);
    }
    
    currentDownloadController = null;
}

function cancelDownload() {
    if (currentDownloadController) {
        if (confirm('Are you sure you want to cancel the download?')) {
            currentDownloadController.abort();
            currentDownloadController = null;
        }
    }
}

    function handleSearch() {
        const input = document.getElementById("searchInput");
        const clearBtn = document.querySelector(".clear-search");
        const searchInfo = document.getElementById("searchInfo");
        const query = input.value.trim();

        clearBtn.style.display = query.length > 0 ? "block" : "none";

        if (searchTimeout) {
            clearTimeout(searchTimeout);
        }

        if (query.length === 0) {
            searchQuery = "";
            page = 1;
            searchInfo.textContent = "üí° Type at least 3 characters to search";
            searchInfo.style.color = "#666";
            document.getElementById("searchResults").style.display = "none";
            loadVoters();
            loadStats();
            return;
        }

        if (query.length < 3) {
            searchInfo.textContent = "‚ö†Ô∏è Type at least 3 characters to search";
            searchInfo.style.color = "#f57c00";
            return;
        }

        searchInfo.textContent = "üîç Searching...";
        searchInfo.style.color = "#666";

        searchTimeout = setTimeout(() => {
            searchQuery = query;
            page = 1;
            loadVoters();
            loadStats();
        }, 500);
    }

    function performSearch() {
        const input = document.getElementById("searchInput");
        const query = input.value.trim();

        if (query.length >= 3) {
            searchQuery = query;
            page = 1;
            loadVoters();
            loadStats();
        } else if (query.length === 0) {
            clearSearch();
        }
    }

    function clearSearch() {
        document.getElementById("searchInput").value = "";
        document.querySelector(".clear-search").style.display = "none";
        document.getElementById("searchInfo").textContent = "üí° Type at least 3 characters to search";
        document.getElementById("searchInfo").style.color = "#666";
        document.getElementById("searchResults").style.display = "none";

        searchQuery = "";
        page = 1;
        loadVoters();
        loadStats();
    }

    function showLoading(show) {
        document.getElementById("loading").style.display = show ? "block" : "none";
    }

    function loadStats() {
        const url = searchQuery 
            ? `${API}/voters/stats?search=${encodeURIComponent(searchQuery)}`
            : `${API}/voters/stats`;

        fetch(url, {
            headers: {
                "Authorization": "Bearer " + localStorage.getItem("token")
            }
        })
        .then(res => res.json())
        .then(data => {
            document.getElementById("totalVoters").innerText = data.data.total_voters;
            document.getElementById("totalMarked").innerText = data.data.total_marked;
            document.getElementById("markedByMe").innerText = data.data.marked_by_me;
        });
    }

    function loadVoters() {
        showLoading(true);

        const url = searchQuery 
            ? `${API}/voters?page=${page}&search=${encodeURIComponent(searchQuery)}`
            : `${API}/voters?page=${page}`;

        fetch(url, {
            headers: {
                "Authorization": "Bearer " + localStorage.getItem("token")
            }
        })
        .then(res => res.json())
        .then(data => {
            showLoading(false);

            const searchResultsDiv = document.getElementById("searchResults");
            const searchInfo = document.getElementById("searchInfo");
            
            if (searchQuery) {
                searchResultsDiv.style.display = "block";
                searchResultsDiv.innerHTML = `
                    üîç Found ${data.total_results} voter(s) matching "${searchQuery}"
                    ${data.total_results > 200 ? '<br>‚ö†Ô∏è Showing first 200 results. Please refine your search for better results.' : ''}
                `;
                searchInfo.style.display = "none";
            } else {
                searchResultsDiv.style.display = "none";
                searchInfo.style.display = "block";
            }

            if (data.data.length === 0) {
                document.getElementById("voterTable").innerHTML = `
                    <tr>
                        <td colspan="8" class="no-results">
                            ${searchQuery ? 'üîç No voters found matching your search' : 'No voters available'}
                        </td>
                    </tr>
                `;
                document.getElementById("nextBtn").disabled = true;
                document.getElementById("prevBtn").disabled = page <= 1;
                return;
            }

            let html = "";
            data.data.forEach(v => {
                let status = v.visited_by_name
                    ? "Visited by " + v.visited_by_name
                    : "Not Visited";

                let action;
                if (isAdmin) {
                    action = v.visited_by_name ? "‚úî" : "-";
                } else {
                    action = v.visited_by_name
                        ? "‚úî"
                        : `<button class="btn-mark" onclick="showPopup('${v.voter_id}', '${v.voter_name}')">Mark</button>`;
                }

                html += `
                    <tr class="${v.visited_by_name ? 'visited' : ''}">
                        <td>${v.serial_no}</td>
                        <td>${v.voter_id}</td>
                        <td>${v.voter_name}</td>
                        <td>${v.relative_name}</td>
                        <td>${v.age}</td>
                        <td>${v.gender}</td>
                        <td>${status}</td>
                        ${isAdmin ? '' : `<td>${action}</td>`}
                    </tr>
                `;
            });

            document.getElementById("voterTable").innerHTML = html;
            document.getElementById("pageNo").innerText = page;

            document.getElementById("prevBtn").disabled = page <= 1;
            document.getElementById("nextBtn").disabled = data.showing < 20;
        })
        .catch(error => {
            showLoading(false);
            console.error("Error loading voters:", error);
            alert("Error loading voters. Please try again.");
        });
    }

    function showPopup(voterId, voterName) {
        selectedVoterId = voterId;
        document.getElementById("voterName").innerText = voterName;
        document.getElementById("popupOverlay").style.display = "block";
    }

    function closePopup() {
        selectedVoterId = null;
        document.getElementById("popupOverlay").style.display = "none";
    }

    function confirmMark() {
        if (selectedVoterId) {
            markVisited(selectedVoterId);
            closePopup();
        }
    }

    function markVisited(voterId) {
        fetch(API + `/voters/${voterId}/visit`, {
            method: "POST",
            headers: {
                "Authorization": "Bearer " + localStorage.getItem("token")
            }
        })
        .then(res => res.json())
        .then(data => {
            alert(data.message);
            loadStats();
            loadVoters();
            if (isAdmin) {
                loadUserStats();
            }
        });
    }

    function nextPage() {
        page++;
        loadVoters();
    }

    function prevPage() {
        if (page > 1) {
            page--;
            loadVoters();
        }
    }

    function logout() {
        localStorage.removeItem("token");
        localStorage.removeItem("isAdmin");
        localStorage.removeItem("userName");
        location.reload();
    }

    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    performSearch();
                }
            });
        }
    });
</script>

</body>
</html>